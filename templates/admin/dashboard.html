{% extends 'base.html' %}

{% block title %}Admin Control{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-10" data-aos="fade-down">
    <div>
        <h1 class="text-3xl font-bold text-white">System Overview</h1>
        <p class="text-gray-400">Monitor activity across the platform</p>
    </div>
    <div class="px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-gray-300 flex items-center gap-4">
        <a href="{{ url_for('admin_users') }}" class="hover:text-white transition flex items-center gap-2">
            <i class="fas fa-users text-blue-400"></i> Manage Users
        </a>
        <span class="w-px h-4 bg-white/10"></span>
        <span class="flex items-center gap-2">
            <i class="fas fa-shield-alt text-indigo-400"></i> Admin Mode
        </span>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
    <div class="glass p-6 rounded-2xl border border-white/5 hover:border-indigo-500/50 transition duration-300"
        data-aos="fade-up" data-aos-delay="0">
        <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">Total Events</p>
        <h3 class="text-3xl font-bold text-white mt-1">{{ stats.total_events }}</h3>
    </div>
    <div class="glass p-6 rounded-2xl border border-white/5 hover:border-yellow-500/50 transition duration-300"
        data-aos="fade-up" data-aos-delay="100">
        <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">Pending</p>
        <h3 class="text-3xl font-bold text-yellow-400 mt-1">{{ stats.pending }}</h3>
    </div>
    <div class="glass p-6 rounded-2xl border border-white/5 hover:border-blue-500/50 transition duration-300"
        data-aos="fade-up" data-aos-delay="200">
        <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">Organizers</p>
        <h3 class="text-3xl font-bold text-blue-400 mt-1">{{ stats.organizers }}</h3>
    </div>
    <div class="glass p-6 rounded-2xl border border-white/5 hover:border-green-500/50 transition duration-300"
        data-aos="fade-up" data-aos-delay="300">
        <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">Photos</p>
        <h3 class="text-3xl font-bold text-green-400 mt-1">{{ stats.total_photos }}</h3>
    </div>
</div>

<!-- Controls -->
<div class="glass p-4 rounded-2xl border border-white/5 mb-8 flex flex-col md:flex-row gap-4 justify-between items-center"
    data-aos="fade-up">
    <div class="relative w-full md:w-96">
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <input type="text" id="searchInput" placeholder="Search events or organizers..."
            class="w-full bg-white/5 border border-white/10 rounded-xl py-2 pl-12 pr-4 text-white focus:outline-none focus:border-indigo-500 transition">
    </div>
    <div class="flex gap-4 w-full md:w-auto">
        <select id="statusFilter"
            class="bg-white/5 border border-white/10 rounded-xl py-2 px-4 text-gray-300 focus:outline-none focus:border-indigo-500 transition w-full md:w-auto">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="completed">Completed</option>
            <option value="rejected">Rejected</option>
        </select>
    </div>
</div>

<!-- Organizers & Events List -->
<div class="space-y-8" id="organizersList">
    {% for organizer in organizers %}
    {% if organizer.organized_events %}
    <div class="organizer-group glass rounded-2xl overflow-hidden border border-white/5" data-aos="fade-up">
        <!-- Header -->
        <div class="p-6 bg-white/5 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold border border-white/10 shadow-lg">
                    {{ organizer.name[:2].upper() }}
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white organizer-name">{{ organizer.name }}</h3>
                    <p class="text-sm text-gray-400 flex items-center"><i class="fas fa-envelope mr-2 text-xs"></i>{{
                        organizer.email }}</p>
                </div>
            </div>
            <span
                class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-xs font-bold border border-blue-500/20">Organizer</span>
        </div>

        <!-- Content Area -->
        <div class="p-4 md:p-6">
            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-gray-500 text-xs uppercase border-b border-white/10">
                            <th class="pb-4 pl-2 font-bold">Event Name</th>
                            <th class="pb-4">Date</th>
                            <th class="pb-4">Status</th>
                            <th class="pb-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-gray-300">
                        {% for event in organizer.organized_events %}
                        <tr class="event-row group hover:bg-white/5 transition border-b border-white/5 last:border-0"
                            data-status="{{ event.status }}" data-name="{{ event.name.lower() }}">
                            <td class="py-4 pl-2 font-medium text-white">{{ event.name }}</td>
                            <td class="py-4 text-gray-400">{{ event.event_date.strftime('%b %d, %Y') }}</td>
                            <td class="py-4">
                                <span class="px-2.5 py-1 rounded-md text-xs font-bold
                                            {% if event.status == 'approved' %}bg-green-500/10 text-green-400 border border-green-500/20
                                            {% elif event.status == 'pending' %}bg-yellow-500/10 text-yellow-400 border border-yellow-500/20
                                            {% else %}bg-red-500/10 text-red-400 border border-red-500/20{% endif %}">
                                    {{ event.status|capitalize }}
                                </span>
                            </td>
                            <td class="py-4 text-right space-x-3 flex items-center justify-end">
                                {% if event.status == 'pending' %}
                                <form method="POST" action="{{ url_for('approve_event', event_id=event.id) }}"
                                    class="inline">
                                    <button class="text-green-400 font-bold hover:underline">Approve</button>
                                </form>
                                <form method="POST" action="{{ url_for('reject_event', event_id=event.id) }}"
                                    class="inline">
                                    <button class="text-red-400 font-bold hover:underline">Reject</button>
                                </form>
                                {% elif event.status == 'approved' %}
                                <form method="POST" action="{{ url_for('complete_event', event_id=event.id) }}"
                                    class="inline">
                                    <button class="text-blue-400 font-bold hover:underline">Mark Complete</button>
                                </form>
                                {% elif event.status == 'completed' %}
                                <form method="POST" action="{{ url_for('clear_photos', event_id=event.id) }}"
                                    class="inline"
                                    onsubmit="return confirm('ADMIN: Delete all photos for this completed event to save storage?');">
                                    <button
                                        class="bg-red-500/10 text-red-500 px-3 py-1 rounded-lg border border-red-500/20 text-xs font-bold hover:bg-red-500 hover:text-white transition">
                                        <i class="fas fa-eraser mr-1"></i> Clear
                                    </button>
                                </form>
                                {% endif %}
                                <form method="POST" action="{{ url_for('force_delete_event', event_id=event.id) }}"
                                    class="inline"
                                    onsubmit="return confirm('CRITICAL: Are you sure you want to PERMANENTLY delete this event?');">
                                    <button class="text-gray-500 hover:text-red-500 transition ml-3"
                                        title="Force Delete Event">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class="md:hidden space-y-4">
                {% for event in organizer.organized_events %}
                <div class="event-card bg-white/5 rounded-xl p-4 border border-white/5" data-status="{{ event.status }}"
                    data-name="{{ event.name.lower() }}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-white text-lg">{{ event.name }}</h4>
                            <p class="text-gray-400 text-sm">{{ event.event_date.strftime('%b %d, %Y') }}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-bold uppercase
                                    {% if event.status == 'approved' %}bg-green-500/20 text-green-400
                                    {% elif event.status == 'pending' %}bg-yellow-500/20 text-yellow-400
                                    {% else %}bg-red-500/20 text-red-400{% endif %}">
                            {{ event.status }}
                        </span>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-3 border-t border-white/10">
                        {% if event.status == 'pending' %}
                        <form method="POST" action="{{ url_for('approve_event', event_id=event.id) }}" class="flex-1">
                            <button
                                class="w-full py-2 bg-green-500/20 text-green-400 rounded-lg text-sm font-bold border border-green-500/30">Approve</button>
                        </form>
                        <form method="POST" action="{{ url_for('reject_event', event_id=event.id) }}" class="flex-1">
                            <button
                                class="w-full py-2 bg-red-500/20 text-red-400 rounded-lg text-sm font-bold border border-red-500/30">Reject</button>
                        </form>
                        {% elif event.status == 'approved' %}
                        <form method="POST" action="{{ url_for('complete_event', event_id=event.id) }}" class="w-full">
                            <button
                                class="w-full py-2 bg-blue-500/20 text-blue-400 rounded-lg text-sm font-bold border border-blue-500/30">Mark
                                Complete</button>
                        </form>
                        {% elif event.status == 'completed' %}
                        <form method="POST" action="{{ url_for('clear_photos', event_id=event.id) }}" class="w-full"
                            onsubmit="return confirm('Delete all photos?');">
                            <button
                                class="w-full py-2 bg-red-500/20 text-red-400 rounded-lg text-sm font-bold border border-red-500/30">Clear
                                Photos</button>
                        </form>
                        {% endif %}

                        <form method="POST" action="{{ url_for('force_delete_event', event_id=event.id) }}"
                            class="w-full mt-2" onsubmit="return confirm('Permanently delete event?');">
                            <button
                                class="w-full py-2 text-gray-500 hover:text-red-500 text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-trash"></i> Delete Event
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="text-center py-20">
        <p class="text-gray-500">No organizers registered with events yet.</p>
    </div>
    {% endfor %}
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const organizerGroups = document.querySelectorAll('.organizer-group');

        function filterEvents() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusTerm = statusFilter.value;

            organizerGroups.forEach(group => {
                const organizerName = group.querySelector('.organizer-name').innerText.toLowerCase();
                let hasVisibleEvents = false;

                // Desktop Rows
                const rows = group.querySelectorAll('.event-row');
                rows.forEach(row => {
                    const name = row.dataset.name;
                    const status = row.dataset.status;
                    const matchesSearch = name.includes(searchTerm) || organizerName.includes(searchTerm);
                    const matchesStatus = statusTerm === 'all' || status === statusTerm;

                    if (matchesSearch && matchesStatus) {
                        row.style.display = '';
                        hasVisibleEvents = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Mobile Cards
                const cards = group.querySelectorAll('.event-card');
                cards.forEach(card => {
                    const name = card.dataset.name;
                    const status = card.dataset.status;
                    const matchesSearch = name.includes(searchTerm) || organizerName.includes(searchTerm);
                    const matchesStatus = statusTerm === 'all' || status === statusTerm;

                    if (matchesSearch && matchesStatus) {
                        card.style.display = '';
                        hasVisibleEvents = true;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show/Hide Organizer Group based on whether they have visible events matches
                if (hasVisibleEvents) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', filterEvents);
        statusFilter.addEventListener('change', filterEvents);
    });
</script>
{% endblock %}