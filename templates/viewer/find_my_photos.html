{% extends 'base.html' %}

{% block title %}AI Search - {{ event.name }}{% endblock %}

{% block content %}
<!-- Back Navigation -->
<a href="{{ url_for('event_gallery', event_id=event.id) }}" class="inline-flex items-center text-gray-400 hover:text-white mb-8 transition group">
    <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-3 group-hover:bg-purple-600 group-hover:text-white transition">
        <i class="fas fa-arrow-left text-sm"></i>
    </div>
    <span class="font-medium">Back to {{ event.name }}</span>
</a>

<div class="max-w-4xl mx-auto">
    <!-- Header Section -->
    <div class="glass rounded-3xl p-10 text-center mb-10 border border-white/5 relative overflow-hidden" data-aos="fade-down">
        <!-- Background Glow -->
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-purple-500/20 rounded-full blur-[80px] -mt-16 pointer-events-none"></div>
        
        <div class="relative z-10">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                <i class="fas fa-face-smile text-4xl"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Find My Photos</h1>
            <p class="text-gray-400 text-lg max-w-lg mx-auto leading-relaxed">
                Upload a selfie or use your camera. Our AI will scan the entire gallery to find you instantly.
            </p>
        </div>
    </div>
    
    {% if face_recognition_available %}
        <!-- Selection Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-10">
            <!-- Option 1: Camera -->
            <div onclick="openSelfieCamera()" 
                 class="glass p-8 rounded-3xl border border-white/5 cursor-pointer group hover:border-purple-500/50 hover:bg-white/5 transition-all duration-300" data-aos="fade-up" data-aos-delay="0">
                <div class="w-16 h-16 bg-purple-500/10 rounded-2xl flex items-center justify-center mb-6 text-purple-400 group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-camera text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2 group-hover:text-purple-400 transition-colors">Use Camera</h3>
                <p class="text-gray-500 text-sm">Take a quick selfie using your device's camera.</p>
            </div>
            
            <!-- Option 2: Upload -->
            <div class="glass p-8 rounded-3xl border border-white/5 cursor-pointer group hover:border-blue-500/50 hover:bg-white/5 transition-all duration-300 relative" data-aos="fade-up" data-aos-delay="100">
                <form method="POST" enctype="multipart/form-data" id="uploadForm" class="absolute inset-0 z-20 cursor-pointer">
                    <input type="file" name="selfie" accept="image/*" required 
                           class="w-full h-full opacity-0 cursor-pointer"
                           onchange="document.getElementById('uploadForm').submit();">
                </form>
                
                <div class="w-16 h-16 bg-blue-500/10 rounded-2xl flex items-center justify-center mb-6 text-blue-400 group-hover:scale-110 transition-transform duration-300 relative z-10 pointer-events-none">
                    <i class="fas fa-cloud-upload-alt text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2 group-hover:text-blue-400 transition-colors relative z-10 pointer-events-none">Upload Photo</h3>
                <p class="text-gray-500 text-sm relative z-10 pointer-events-none">Select an existing photo from your gallery.</p>
            </div>
        </div>
        
        <!-- Tips -->
        <div class="p-5 rounded-2xl bg-blue-500/5 border border-blue-500/10 flex items-start gap-4" data-aos="fade-up" data-aos-delay="200">
            <div class="mt-1 text-blue-400"><i class="fas fa-lightbulb"></i></div>
            <div>
                <h4 class="font-bold text-blue-200 text-sm mb-1">Tips for best results</h4>
                <p class="text-gray-400 text-xs leading-relaxed">
                    Ensure your face is clearly visible. Avoid sunglasses, masks, or extreme angles. Good lighting helps the AI match faces accurately.
                </p>
            </div>
        </div>

    {% else %}
        <!-- Fallback if AI not installed -->
        <div class="glass rounded-3xl p-12 text-center border border-dashed border-yellow-500/30" data-aos="fade-up">
            <i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-6"></i>
            <h3 class="text-2xl font-bold text-white mb-3">AI Not Active</h3>
            <p class="text-gray-400 mb-8 max-w-md mx-auto">
                The face recognition module is currently unavailable on this server. Please browse the gallery manually.
            </p>
            <a href="{{ url_for('event_gallery', event_id=event.id) }}" 
               class="px-8 py-3 rounded-xl bg-white text-slate-900 font-bold hover:bg-gray-100 transition">
                Return to Gallery
            </a>
        </div>
    {% endif %}
</div>

<!-- Results Section -->
{% if matched_photos %}
<div class="max-w-7xl mx-auto mt-16" data-aos="fade-up">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">
                Found {{ matched_photos|length }} Match{% if matched_photos|length > 1 %}es{% endif %}
            </h2>
        </div>
        
        <form method="POST" action="{{ url_for('download_matched_photos') }}">
            {% for photo in matched_photos %}
                <input type="hidden" name="photo_ids" value="{{ photo.id }}">
            {% endfor %}
            <button type="submit" class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-500 transition shadow-lg shadow-green-600/20 flex items-center">
                <i class="fas fa-download mr-2"></i> Download All
            </button>
        </form>
    </div>
    
    <div class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4">
        {% for photo in matched_photos %}
        <div class="break-inside-avoid relative group rounded-xl overflow-hidden cursor-zoom-in bg-slate-800 border border-white/5">
            <img src="{{ url_for('static', filename='uploads/photos/' ~ photo.filename) }}" 
                 class="w-full h-auto block transform transition-transform duration-700 group-hover:scale-110">
            
            <div class="absolute top-2 right-2 z-10">
                <span class="px-2 py-1 rounded bg-green-500 text-white text-[10px] font-bold uppercase tracking-wide shadow-lg">
                    Match
                </span>
            </div>
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                <div class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                    <a href="{{ url_for('download_photo', photo_id=photo.id) }}" 
                       class="w-full py-2.5 rounded-lg bg-white text-slate-900 font-bold text-sm flex items-center justify-center hover:bg-gray-100 transition">
                        <i class="fas fa-download mr-2"></i> Download
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Selfie Camera Modal (Dark Theme) -->
<div id="selfieCameraModal" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-md">
    <div class="h-full flex flex-col max-w-lg mx-auto bg-black relative">
        <!-- Header -->
        <div class="flex justify-between items-center p-6 text-white absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/80 to-transparent">
            <h3 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-camera text-purple-500"></i> Take Selfie
            </h3>
            <button onclick="closeSelfieCamera()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition backdrop-blur-md">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Camera View -->
        <div class="flex-1 relative flex items-center justify-center bg-black overflow-hidden">
            <video id="selfieStream" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
            <canvas id="selfieCanvas" class="hidden"></canvas>
            
            <!-- Face Guide Overlay -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-50">
                <div class="w-64 h-80 border-2 border-white/30 rounded-[50%] border-dashed"></div>
            </div>
        </div>
        
        <!-- Preview Container -->
        <div id="selfiePreviewContainer" class="hidden absolute inset-0 bg-black z-30 flex flex-col">
            <div class="flex-1 relative">
                <img id="selfiePreview" class="w-full h-full object-cover transform scale-x-[-1]">
            </div>
            <div class="p-6 bg-black flex gap-4">
                <button onclick="retakeSelfie()" class="flex-1 py-4 rounded-2xl bg-gray-800 text-white font-bold hover:bg-gray-700 transition">
                    <i class="fas fa-redo mr-2"></i> Retake
                </button>
                <button onclick="searchWithSelfie()" class="flex-1 py-4 rounded-2xl bg-purple-600 text-white font-bold hover:bg-purple-500 transition shadow-lg shadow-purple-600/30">
                    <i class="fas fa-search mr-2"></i> Find Photos
                </button>
            </div>
        </div>
        
        <!-- Capture Controls -->
        <div id="selfieCaptureBtn" class="p-8 bg-black flex justify-center items-center pb-12">
            <button onclick="captureSelfie()" 
                    class="w-20 h-20 rounded-full border-4 border-white/30 flex items-center justify-center hover:scale-110 transition-transform duration-200">
                <div class="w-16 h-16 bg-white rounded-full"></div>
            </button>
        </div>
        
        <!-- Searching State -->
        <div id="selfieSearching" class="hidden absolute inset-0 bg-black/90 z-40 flex flex-col items-center justify-center text-white">
            <div class="w-16 h-16 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
            <h3 class="text-xl font-bold mb-2">Scanning Gallery...</h3>
            <p class="text-gray-400">Analyzing faces with AI</p>
        </div>
    </div>
</div>

<script>
let selfieStream = null;
let selfieImageData = null;
const eventId = {{ event.id }};

function openSelfieCamera() {
    document.getElementById('selfieCameraModal').classList.remove('hidden');
    startSelfieCamera();
}

function closeSelfieCamera() {
    stopSelfieCamera();
    document.getElementById('selfieCameraModal').classList.add('hidden');
    document.getElementById('selfiePreviewContainer').classList.add('hidden');
    document.getElementById('selfieCaptureBtn').classList.remove('hidden');
    document.getElementById('selfieSearching').classList.add('hidden');
}

async function startSelfieCamera() {
    try {
        const video = document.getElementById('selfieStream');
        selfieStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        video.srcObject = selfieStream;
    } catch (err) {
        console.error('Camera error:', err);
        alert('Unable to access camera. Please use the file upload option instead.');
        closeSelfieCamera();
    }
}

function stopSelfieCamera() {
    if (selfieStream) {
        selfieStream.getTracks().forEach(track => track.stop());
        selfieStream = null;
    }
}

function captureSelfie() {
    const video = document.getElementById('selfieStream');
    const canvas = document.getElementById('selfieCanvas');
    const preview = document.getElementById('selfiePreview');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    // Flip horizontally for selfie
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0);
    
    selfieImageData = canvas.toDataURL('image/jpeg', 0.9);
    preview.src = selfieImageData;
    
    document.getElementById('selfiePreviewContainer').classList.remove('hidden');
    document.getElementById('selfieCaptureBtn').classList.add('hidden');
    
    stopSelfieCamera();
}

function retakeSelfie() {
    selfieImageData = null;
    document.getElementById('selfiePreviewContainer').classList.add('hidden');
    document.getElementById('selfieCaptureBtn').classList.remove('hidden');
    startSelfieCamera();
}

async function searchWithSelfie() {
    if (!selfieImageData) return;
    
    document.getElementById('selfieSearching').classList.remove('hidden');
    
    try {
        const response = await fetch(`/viewer/event/${eventId}/find-my-photos`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image: selfieImageData })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeSelfieCamera();
            if (result.count > 0) {
                location.reload();
            } else {
                alert('No matching photos found. Try a clearer selfie.');
            }
        } else {
            alert('Search failed: ' + (result.message || 'Unknown error'));
            document.getElementById('selfieSearching').classList.add('hidden');
            retakeSelfie();
        }
    } catch (err) {
        console.error('Search error:', err);
        alert('Search failed. Please try the file upload option.');
        closeSelfieCamera();
    }
}
</script>
{% endblock %}